---
variant: flatcar
version: 1.1.0

storage:
  files:

systemd:
  units:

    - name: kubeadm.service
      enabled: false
      contents: |
        [Unit]
        StartLimitInterval=200
        StartLimitBurst=5
        Description=Kubeadm service
        Requires=haproxy.service
        After=haproxy.service
        ConditionPathExists=!/etc/kubernetes/kubelet.conf
        [Service]
        EnvironmentFile=/etc/kubernetes/kubeadm-env.conf
        EnvironmentFile=/etc/kubernetes/certs.conf
        # We skip kube-proxy because we install cilium
        ExecStartPre=/usr/bin/kubeadm init \
          --token $${K8S_TOKEN} \
          --cri-socket=unix:///var/run/crio/crio.sock \
          --skip-phases=addon/kube-proxy \
          --control-plane-endpoint $${K8S_APISERVER_URL}:6444 \
          --upload-certs
        ExecStartPre=/usr/bin/mkdir /home/core/.kube
        ExecStartPre=/usr/bin/cp \
          /etc/kubernetes/admin.conf \
          /home/core/.kube/config
        ExecStartPre=/usr/bin/chown -R core:core /home/core/.kube
        ExecStartPre=kubectl \
           --kubeconfig=/etc/kubernetes/admin.conf \
          taint node ${hostname} \
          node-role.kubernetes.io/control-plane:NoSchedule-
        ExecStart=/usr/bin/true
        [Install]
        WantedBy=multi-user.target
