---
variant: flatcar
version: 1.1.0

storage:
  files:

systemd:

  units:

    - name: kubeadm.service
      enabled: true
      contents: |
        [Unit]
        StartLimitInterval=200
        StartLimitBurst=5
        Description=Kubeadm service
        Requires=crio.service
        After=crio.service
        ConditionPathExists=!/etc/kubernetes/kubelet.conf
        [Service]
        Type=oneshot
        EnvironmentFile=/etc/kubernetes/kubeadm-env.conf
        EnvironmentFile=/etc/kubernetes/certs.conf
        ExecStartPre=/usr/bin/kubeadm config images pull
        ExecStartPre=/usr/bin/sh -c \
          "while ! nc -z $${K8S_APISERVER_URL} 6444; do sleep 5; done"
        ExecStartPre=/usr/bin/kubeadm join \
          $${K8S_APISERVER_URL}:6444 \
          --token $${K8S_TOKEN} \
          --discovery-token-ca-cert-hash $${K8S_HASH} \
          --ignore-preflight-errors=FileAvailable--etc-kubernetes-pki-ca.crt \
          --cri-socket=unix:///var/run/crio/crio.sock \
          --control-plane
          # --certificate-key $${K8S_CERT_KEY}
        ExecStartPre=/usr/bin/mkdir /home/core/.kube
        ExecStartPre=/usr/bin/cp \
          /etc/kubernetes/admin.conf \
          /home/core/.kube/config
        ExecStartPre=/usr/bin/chown -R core:core /home/core/.kube
        ExecStart=/usr/bin/true
        [Install]
        WantedBy=multi-user.target
